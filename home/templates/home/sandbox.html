{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRADE</title>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >
    <link href="{% static 'css/sandbox.css' %}" rel="stylesheet">
</head>
<body>

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4" style="text-align: center; color: white; font-weight: bold;">Sandbox</h2>
    <form id="sandboxForm" method="POST" class="d-flex flex-column align-items-center">
        {% csrf_token %}
        <div class="mb-3 w-50">
            <label for="numQuestions" class="form-label" style="text-align: center; color: white; font-weight: bold;">Number of Questions</label>
            <input type="number" id="numQuestions" name="num_questions" class="form-control" min="1" required>
        </div>
        <div id="questionsContainer" class="d-flex flex-wrap justify-content-center gap-3"></div>
        <button id="generateBtn" type="submit" class="btn btn-primary mt-4">Generate Questions</button>
    </form>
    <div id="loadingIndicator" class="text-center mt-3" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p style="color: white; font-weight: bold;">Generating questions, please wait...</p>
    </div>
    <div id="generatedQuestions" class="mt-5"></div>
    <button id="downloadPdfBtn" class="btn btn-success mt-3" style="display: none;">Download PDF</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.getElementById("numQuestions").addEventListener("input", function () {
    const num = parseInt(this.value) || 0;
    const container = document.getElementById("questionsContainer");
    container.innerHTML = "";

    for (let i = 0; i < num; i++) {
        const card = document.createElement("div");
        card.classList.add("card", "p-3", "shadow-sm");
        card.style.width = "300px";
        card.innerHTML = `
            <div class="mb-3">
                <label for="clo_${i}" class="form-label">CLO</label>
                <select id="clo_${i}" name="clo_${i}" class="form-control">
                    <option value="Data Types">Data Types</option>
                    <option value="Strings">Strings</option>
                    <option value="Arithmetic Operations">Arithmetic Operations</option>
                    <option value="Logical Operations">Logical Operations</option>
                    <option value="Input/Output Operations">Input/Output Operations</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="type_${i}" class="form-label">Type</label>
                <select id="type_${i}" name="type_${i}" class="form-control">
                    <option value="code">Code</option>
                    <option value="theory">Theory</option>
                </select>
            </div>
        `;
        container.appendChild(card);
    }
});

document.getElementById("sandboxForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const generateBtn = document.getElementById("generateBtn");
    const loadingIndicator = document.getElementById("loadingIndicator");

    generateBtn.disabled = true;
    loadingIndicator.style.display = "block";

    try {
        const formData = new FormData(this);
        const response = await fetch("{% url 'home:sandbox' %}", {
            method: "POST",
            body: formData,
        });

        if (!response.ok) {
            throw new Error("Failed to fetch data. Please try again.");
        }

        const data = await response.json();
        const generatedQuestions = document.getElementById("generatedQuestions");

        generatedQuestions.innerHTML = `
            <h4 class="text-center">Generated Questions:</h4>
            <div class="card p-3 shadow-lg mt-3">
                ${data.questions
                    .map((q, index) => `<p><strong>${index + 1}.</strong> ${q}</p>`)
                    .join("")}
            </div>
        `;

        // Show the download PDF button
        const downloadPdfBtn = document.getElementById("downloadPdfBtn");
        downloadPdfBtn.style.display = "block";

        downloadPdfBtn.onclick = function () {
        const { jsPDF } = window.jspdf; // Access jsPDF from the namespace
        if (!jsPDF) {
            alert("jsPDF is not loaded properly.");
            return;
        }

        const pdf = new jsPDF();
        const fileName = prompt("Enter a name for your PDF file", "questions") || "questions";

        // Extract questions while keeping them as single units
        const questions = Array.from(document.querySelectorAll('#generatedQuestions p'))
            .map((p) => p.textContent.trim());

        if (questions.length === 0) {
            alert("No content available to generate the PDF.");
            return;
        }

        // Set custom font and font size
        pdf.setFont("times", "normal"); // Times New Roman
        pdf.setFontSize(12); // Reduced font size for readability

        const questionSpacing = 12; // Spacing between questions
        const lineSpacing = 6; // Spacing between lines within a question
        let y = 20; // Initial y-coordinate for the text
        const pageHeight = 280; // Page height for A4 size

        // Loop through each question
        questions.forEach((question, index) => {
            // Format the question with its number
            const formattedQuestion = `${index + 1}. ${question}`;

            // Split text into lines to handle long content
            const lines = pdf.splitTextToSize(formattedQuestion, 180); // Wrap text at 180 units

            // Check if adding this question exceeds the page height
            if (y + lines.length * lineSpacing + questionSpacing > pageHeight) {
                pdf.addPage(); // Add a new page if necessary
                y = 20; // Reset y for new page
            }

            // Add each line of the question to the PDF
            lines.forEach((line) => {
                pdf.text(line, 10, y);
                y += lineSpacing; // Tight spacing between lines of the same question
            });

            y += questionSpacing; // Extra space after the question
        });

        // Save the PDF with the user-provided file name
        pdf.save(`${fileName}.pdf`);
    };
    } catch (error) {
        alert(error.message);
    } finally {
        generateBtn.disabled = false;
        loadingIndicator.style.display = "none";
    }
});
</script>
{% endblock %}

</body>
</html>
